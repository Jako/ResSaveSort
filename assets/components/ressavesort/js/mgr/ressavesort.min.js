/*!
 * ResSaveSort - Sort MODX containers after saving resources.
 * Version: 1.0.3
 * Build date: 2017-01-08
 */

var resSaveSort=function(a){a=a||{},resSaveSort.superclass.constructor.call(this,a)};Ext.extend(resSaveSort,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},jquery:{},form:{}}),Ext.reg("ressavesort",resSaveSort),ResSaveSort=new resSaveSort,ResSaveSort.grid.Systemsetting=function(a){a=a||{},this.ident=a.ident||"ressavesort-mecitem"+Ext.id(),this.buttonColumnTpl=new Ext.XTemplate('<tpl for="."><tpl if="action_buttons !== null"><ul class="action-buttons"><tpl for="action_buttons"><li><i class="icon {className} icon-{icon}" title="{text}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0}),this.hiddenField=new Ext.form.TextArea({name:a.hiddenName||a.name,hidden:!0}),Ext.applyIf(a,{id:this.ident+"-systemsetting-grid",fields:["id","sortby","sortdir","sortcontainer","rank"],autoHeight:!0,store:new Ext.data.JsonStore({fields:["id","sortby","sortdir","sortcontainer","rank"],data:Ext.util.JSON.decode(a.value)}),enableDragDrop:!0,ddGroup:this.ident+"-systemsetting-grid-dd",autoExpandColumn:"value",labelStyle:"position: absolute",columns:[{dataIndex:"id",hidden:!0},{header:_("setting_ressavesort.sortby"),dataIndex:"sortby",editable:!0,editor:{xtype:"textfield",allowBlank:!1,listeners:{change:{fn:this.saveValue,scope:this}}},width:100},{header:_("setting_ressavesort.sortdir"),dataIndex:"sortdir",editable:!0,editor:{xtype:"textfield",listeners:{change:{fn:this.saveValue,scope:this}}},width:100},{header:_("setting_ressavesort.sortcontainer"),dataIndex:"sortcontainer",editable:!0,editor:{xtype:"textfield",listeners:{change:{fn:this.saveValue,scope:this}}},width:100},{renderer:{fn:this.buttonColumnRenderer,scope:this},width:30,align:"right"},{dataIndex:"rank",hidden:!0}],tbar:["->",{text:'<i class="icon icon-plus"></i> '+_("add"),cls:"primary-button",handler:this.addEntry,scope:this}],listeners:{render:{fn:this.renderListener,scope:this}}}),ResSaveSort.grid.Systemsetting.superclass.constructor.call(this,a)},Ext.extend(ResSaveSort.grid.Systemsetting,MODx.grid.LocalGrid,{windows:{},getMenu:function(){var a=[];return a.push({text:_("remove"),handler:this.removeEntry}),a},addEntry:function(){var a=this.getStore(),b=new a.recordType({targetwidth:"",targetheight:"",targetRatio:""});this.getStore().insert(0,b),this.getView().refresh(),this.getSelectionModel().selectRow(0)},removeEntry:function(){Ext.Msg.confirm(_("remove")||"",_("confirm_remove")||"",function(a){if("yes"==a){var b=this.getStore(),c=this.getSelectionModel().getSelections();if(!c.length)return!1;for(var d=0;d<c.length;d++){var e=(c[d].id,b.findBy(function(a,b){if(a.id==b)return!0}));b.removeAt(e)}this.getView().refresh(),this.saveValue()}},this)},renderListener:function(a,b,c,d){return a.container instanceof Ext.Layer?(a.container.addListener("beforestartedit",function(){return!1}),console.log(a),!1):(new Ext.dd.DropTarget(a.container,{copy:!1,ddGroup:this.ident+"-systemsetting-grid-dd",notifyDrop:function(b,c,d){var e=a.store,f=a.getSelectionModel(),g=f.getSelections(),h=b.getDragData(c);if(h){var i=h.rowIndex;if("undefined"!=typeof i){for(var j=0;j<g.length;j++)e.remove(e.getById(g[j].id));e.insert(i,d.selections),f.clearSelections()}}a.getView().refresh(),a.saveValue()}}),this.add(this.hiddenField),this.saveValue(),void 0)},buttonColumnRenderer:function(){var a={action_buttons:[{className:"remove",icon:"trash-o",text:_("remove")}]};return this.buttonColumnTpl.apply(a)},onClick:function(a){var b=a.getTarget(),c=b.className.split(" ")[0];if("icon"==c){var d=b.className.split(" ")[1],e=this.getSelectionModel().getSelected();switch(this.menu.record=e.data,d){case"remove":this.removeEntry(e,a)}}},saveValue:function(){var a=[];Ext.each(this.getStore().getRange(),function(b){a.push({sortby:b.data.sortby,sortdir:b.data.sortdir,sortcontainer:b.data.sortcontainer})}),this.hiddenField.setValue(Ext.util.JSON.encode(a))}}),Ext.reg("combo-ressavesort-grid",ResSaveSort.grid.Systemsetting);